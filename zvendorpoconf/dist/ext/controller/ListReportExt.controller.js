jQuery.sap.require("amer.zmm.zvendorpoconf.utils.jszip");jQuery.sap.require("amer.zmm.zvendorpoconf.utils.xlsx");sap.ui.define(["sap/m/MessageToast","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV"],function(e,a,t){"use strict";return{onInit:function(){var e=new t;this.getView().setModel(e,"tableData")},VendorConfirmation:function(e){if(!this.pDialog){this.pDialog=this.loadFragment({name:"amer.zmm.zvendorpoconf.ext.view.fragments.vendorConfirmation",controller:this})}this.pDialog.then(function(e){this.pDialog=e;e.open();this.handleVendorSelectedItems()}.bind(this))},handleVendorClosePress:function(e){this.pDialog.close();this.pDialog.destroy();this.pDialog=null},handleVendorSelectedItems:function(e){var a=sap.ui.getCore().byId("amer.zmm.zvendorpoconf::sap.suite.ui.generic.template.ListReport.view.ListReport::ZCC_MM_VEN_PO_CNF--GridTable");var t=a.getPlugins()[0].getSelectedIndices();var r=[];for(var s=0;s<t.length;s++){r.push(a.getBinding("rows").getContexts()[t[s]].getObject())}var i=new sap.ui.model.json.JSONModel({selectedVendorData:r});this.getView().byId("idSelectedVendorsTable").setModel(i)},handleVendorSubmitPress:function(){debugger;sap.ui.core.BusyIndicator.show();var e=this.getView().byId("idSelectedVendorsTable");var a=e.getBinding("rows").getContexts();var t={};var r=[];for(var s=0;s<a.length;s++){var i=a[s].getObject();if(!i.SupplierCnfQty2){i.SupplierCnfQty2="0"}if(!i.SupplierCnfQty3){i.SupplierCnfQty3="0"}if(!i.SupplierCnfQty4){i.SupplierCnfQty4="0"}r.push({PurchaseOrder:i.PurchaseOrder,PurchaseOrderItem:i.PurchaseOrderItem,PurchasingOrganization:i.PurchasingOrganization,PurchasingGroup:i.PurchasingGroup,Supplier:i.Supplier,OrderQuantity:i.OrderQuantity,PurchaseOrderQuantityUnit:i.PurchaseOrderQuantityUnit,PickUpDate:i.PickUpDate,SupplierCnfDate1:i.SupplierCnfDate1,SupplierCnfQty1:i.SupplierCnfQty1,SupplierCnfRef1:i.SupplierCnfRef1,SupplierDelayReason1:i.SupplierDelayReason1,SupplierCnfDate2:i.SupplierCnfDate2,SupplierCnfQty2:i.SupplierCnfQty2,SupplierCnfRef2:i.SupplierCnfRef2,SupplierDelayReason2:i.SupplierDelayReason2,SupplierCnfDate3:i.SupplierCnfDate3,SupplierCnfQty3:i.SupplierCnfQty3,SupplierCnfRef3:i.SupplierCnfRef3,SupplierDelayReason3:i.SupplierDelayReason3,SupplierCnfDate4:i.SupplierCnfDate4,SupplierCnfQty4:i.SupplierCnfQty4,SupplierCnfRef4:i.SupplierCnfRef4,SupplierDelayReason4:i.SupplierDelayReason4})}var n=this.getOwnerComponent().getModel();var o=n.getDeferredGroups();o[o.length]="createMultiple";n.setDeferredGroups(o);for(var p=0;p<r.length;p++){n.create("/POVendorCnfLnsSet",r[p],{groupId:"createMultiple"})}n.submitChanges({groupId:"createMultiple",success:function(e,a){sap.ui.core.BusyIndicator.hide();var t=[];var r=false;e.__batchResponses[0].__changeResponses.forEach((e,a)=>{t.push(e.data);if(e.data.MsgTyp==="E"){r=true}});if(r){sap.m.MessageBox.error("Errors occured for one of the lines, please see the highlighted lines in red")}else{sap.m.MessageBox.success("Selected PO Lines are Successfully Processed")}this.getView().byId("idSelectedVendorsTable").getModel().setProperty("/selectedVendorData",t);this.getView().byId("idSelectedVendorsTable").clearSelection()}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide()}})},POVendorMassConf:function(e){var a=sap.ushell.Container.getService("CrossApplicationNavigation");var t=a&&a.hrefForExternal({target:{semanticObject:"ZMM_PO_VENDOR_CONF",action:"massConfirmation"}});var r=window.location.href.split("#")[0]+t;sap.m.URLHelper.redirect(r,true)},openSpreadsheetUpload:async function(e){if(!this.sHDialog){this.sHDialog=this.loadFragment({name:"amer.zmm.zvendorpoconf.ext.view.fragments.spreadSheetUpload",controller:this})}this.sHDialog.then(function(e){this.spreadSheetDialog=e;e.open();this.template=this.byId("idFileData").clone();this._oComponent=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))}.bind(this))},chunkArrayInGroups:function(e,a){var t=[];for(var r=0;r<e.length;r+=a){t.push(e.slice(r,r+a))}return t},changeFileUploader:function(e){var a=e.getSource().oFileUpload.files[0];var t=new FileReader;t.onload=function(e){var a=e.target.result;var t=XLSX.read(a,{type:"binary"});t.SheetNames.forEach(function(e){var a=XLSX.utils.sheet_to_row_object_array(t.Sheets[e],{raw:false,defval:""});var r=JSON.stringify(a);this.jsonArrayData=r}.bind(this))}.bind(this);t.onerror=function(e){};t.readAsBinaryString(e.getSource().oFileUpload.files[0])},tableDataKeyMap:function(e){var a=new Set(["PurchaseOrder","PurchaseOrderItem","SupplierCnfDate1","SupplierCnfQty1","SupplierCnfRef1","SupplierDelayReason1","SupplierCnfDate2","SupplierCnfQty2","SupplierCnfRef2","SupplierDelayReason2","SupplierCnfDate3","SupplierCnfQty3","SupplierCnfRef3","SupplierDelayReason3","SupplierCnfDate4","SupplierCnfQty4","SupplierCnfRef4","SupplierDelayReason4"]);var t=e.map(e=>{const t={};Object.values(e).map((e,r)=>{const s=[...a][r];t[s]=e});return t});return t},onPress:function(e){var a=this;var t=this.getView().getModel();this.getView().byId("fileUploader").clear();var r={};if(this.jsonArrayData){var s=this.template;this.jsonArrayData=JSON.parse(this.jsonArrayData)}var i=new sap.ui.model.json.JSONModel;i.setData(this.jsonArrayData);this.mappedNewKeydata=this.tableDataKeyMap(this.jsonArrayData);i.setData(this.mappedNewKeydata);this.byId("idFileData").setModel(i);this.byId("idFileData").bindRows("/",s);var n;for(var o=0;o<this.jsonArrayData.length;o++){if(this.jsonArrayData[o].Message){n="X";break}}},OnPostVCL:function(e){var a=this;if(this.jsonArrayData){var t=this._oComponent.getModel();var r=[];for(var s=0;s<this.mappedNewKeydata.length;s++){var i={PurchaseOrder:this.mappedNewKeydata[s]["PurchaseOrder"],PurchaseOrderItem:this.mappedNewKeydata[s]["PurchaseOrderItem"],SupplierCnfDate1:new Date(this.mappedNewKeydata[s]["SupplierCnfDate1"]),SupplierCnfQty1:this.mappedNewKeydata[s]["SupplierCnfQty1"],SupplierCnfRef1:this.mappedNewKeydata[s]["SupplierCnfRef1"],SupplierDelayReason1:this.mappedNewKeydata[s]["SupplierDelayReason1"],SupplierCnfDate2:new Date(this.mappedNewKeydata[s]["SupplierCnfDate2"]),SupplierCnfQty2:this.mappedNewKeydata[s]["SupplierCnfQty2"],SupplierCnfRef2:this.mappedNewKeydata[s]["SupplierCnfRef2"],SupplierDelayReason2:this.mappedNewKeydata[s]["SupplierDelayReason2"],SupplierCnfDate3:new Date(this.mappedNewKeydata[s]["SupplierCnfDate3"]),SupplierCnfQty3:this.mappedNewKeydata[s]["SupplierCnfQty3"],SupplierCnfRef3:this.mappedNewKeydata[s]["SupplierCnfRef3"],SupplierDelayReason3:this.mappedNewKeydata[s]["SupplierDelayReason3"],SupplierCnfDate4:new Date(this.mappedNewKeydata[s]["SupplierCnfDate4"]),SupplierCnfQty4:this.mappedNewKeydata[s]["SupplierCnfQty4"],SupplierCnfRef4:this.mappedNewKeydata[s]["SupplierCnfRef4"],SupplierDelayReason4:this.mappedNewKeydata[s]["SupplierDelayReason4"],Message:""};this.arrayResponse=[];r.push(i);jQuery.sap.vcLinesArr=r}var n=new sap.m.Dialog({title:"Warning!",type:"Message",content:new sap.m.Text({text:"System will create the confirmation lines now. Please confirm?"}),beginButton:new sap.m.Button({text:"OK",press:function(){sap.ui.core.BusyIndicator.show();a.onPostDataForeground(r);n.close()}}),endButton:new sap.m.Button({text:"Cancel",press:function(){n.close()}}),afterClose:function(){n.destroy()}});n.open()}},onPostDataForeground:function(e){this.totalRecordsLength=e.length;var a=[];var t=[];var r=this.getOwnerComponent().getModel().sServiceUrl;var s=new sap.ui.model.odata.ODataModel(r,{json:true});var i=[];var i=this.chunkArrayInGroups(e,400);if(jQuery.sap.flg==undefined){jQuery.sap.flg=0}var n=[];n=i[jQuery.sap.flg];for(var o=0;o<n.length;o++){var p=n[o];a.push(s.createBatchOperation("/POVendorCnfLnsSet","POST",p))}s.addBatchChangeOperations(a);s.setUseBatch(true);var l=this;s.submitBatch(function(e,a){var t=[];for(var r=0;r<e.__batchResponses[0].__changeResponses.length;r++){t.push(e.__batchResponses[0].__changeResponses[r].data)}if(l.arrayResponse.length>0){Array.prototype.push.apply(l.arrayResponse,t)}else{l.arrayResponse=t}if(l.totalRecordsLength===l.arrayResponse.length){var s=l.template;var n=new sap.ui.model.json.JSONModel;n.setData(l.arrayResponse);l.jsonArrayData=l.arrayResponse;l.byId("idFileData").setModel(n);l.byId("idFileData").bindRows("/",s);sap.ui.core.BusyIndicator.hide();var o="N";for(var p=0;p<l.arrayResponse.length;p++){if(l.arrayResponse[p].Message){o="Y";break}}if(l.arrayResponse[0].MsgTy==="V"&&o==="Y"){MessageBox.error(l.arrayResponse[0].HeaderMessage)}if(l.arrayResponse[0].MsgTy==="V"&&o==="N"){MessageBox.success(l.arrayResponse[0].HeaderMessage);l.byId("idPostMJELns").setVisible(true)}if(l.arrayResponse[0].MsgTy==="E"){MessageBox.error(l.arrayResponse[0].HeaderMessage);l.byId("idErrorLog").setVisible(true)}if(l.arrayResponse[0].MsgTy==="I"){MessageBox.success(l.arrayResponse[0].HeaderMessage);l.byId("idPostMJELns").setEnabled(false)}}if(jQuery.sap.flg<i.length-1){jQuery.sap.flg++;this.onPostDataForeground(jQuery.sap.mjeLinesArr)}else if(jQuery.sap.flg==i.length-1){jQuery.sap.flg=undefined}}.bind(this),function(e){sap.ui.core.BusyIndicator.hide()})},VendorPOQuickCnf:function(e){sap.m.MessageBox.confirm("For the selected PO Lines, Confirmation line will be created with Requested Delivery date & Requested Qty",{title:"Confirm",styleClass:"",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],emphasizedAction:sap.m.MessageBox.Action.OK,initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit,onClose:e=>{if(e==="OK"){debugger;var a=sap.ui.getCore().byId("amer.zmm.zvendorpoconf::sap.suite.ui.generic.template.ListReport.view.ListReport::ZCC_MM_VEN_PO_CNF--GridTable");var t=a.getPlugins()[0].getSelectedIndices();var r=[];for(var s=0;s<t.length;s++){var i=a.getBinding("rows").getContexts()[t[s]].getObject();r.push({PurchaseOrder:i.PurchaseOrder,PurchaseOrderItem:i.PurchaseOrderItem,PurchasingOrganization:i.PurchasingOrganization,PurchasingGroup:i.PurchasingGroup,Supplier:i.Supplier,OrderQuantity:i.OrderQuantity,PurchaseOrderQuantityUnit:i.PurchaseOrderQuantityUnit,PickUpDate:i.PickUpDate,SupplierCnfDate1:i.PickUpDate,SupplierCnfQty1:i.OrderQuantity})}var n=this.getOwnerComponent().getModel();var o=n.getDeferredGroups();o[o.length]="createMultiple";n.setDeferredGroups(o);for(var p=0;p<r.length;p++){n.create("/POVendorCnfLnsSet",r[p],{groupId:"createMultiple"})}n.submitChanges({groupId:"createMultiple",success:function(e,a){debugger;var t=[];var r=false;e.__batchResponses[0].__changeResponses.forEach((e,a)=>{t.push(e.data);if(e.data.MsgTyp==="E"){r=true}});this.quickConfirmationDialog(t,r)}.bind(this),error:function(e){}})}}})},quickConfirmationDialog:function(e,a){if(!this.qDialog){this.qDialog=this.loadFragment({name:"amer.zmm.zvendorpoconf.ext.view.fragments.quickConfirmationDialog",controller:this})}this.qDialog.then(function(t){this.qDialog=t;var r=new sap.ui.model.json.JSONModel({quickVendorData:e});this.getView().byId("idQuickConfirmationTable").setModel(r);t.open();if(a){sap.m.MessageBox.error("Errors occured for one of the lines, please see the highlighted lines in red")}else{sap.m.MessageBox.success("Selected PO Lines are successfully processed")}}.bind(this))},OnPostVCClose:function(e){this.spreadSheetDialog.close();this.getView().byId("idFileData").getModel().setData("")},handleDate:function(e){if(e){var a=new Date(e);var t=sap.ui.core.format.DateFormat.getDateInstance({style:"short"});if(isNaN(a.getDate())){return a}else{return t.format(a)}}},quickConfirmationDialogClose:function(){this.qDialog.close();this.qDialog.destroy(true);this.qDialog=null}}});
//# sourceMappingURL=ListReportExt.controller.js.map